# TODO

GOAL: Ideally we have Pixel, A1, Clive, and one Denizen all published on the same day.

## Plan to achieve "Same Day" Publishing:

This plan involves modifying `app.py` to accept explicit month and week arguments, and then updating `generate_articles_all_reporters.py` to pass these arguments for all generated content, including a Denizen profile.

### Phase 1: Modify `app.py` to accept a specific publish date.

1.  **Update `app.py`'s `ArgumentParser`:**
    *   Add two new optional arguments: `--month` and `--week`. These will allow overriding the automatic date calculation (`get_next_story_id`).
    *   **Code Change (app.py):**
        ```python
        # In the ArgumentParser section, add:
        parser.add_argument(
            "--month",
            type=int,
            default=None,
            help="Specify the month number (e.g., 1 for Cycle 001) for generated content. Overrides automatic month calculation."
        )
        parser.add_argument(
            "--week",
            type=int,
            default=None,
            help="Specify the week number (e.g., 1 for Week 01) for generated content. Overrides automatic week calculation."
        )
        ```

2.  **Modify `app.py`'s `run_generative_workflow` function:**
    *   Update its signature to accept `month_arg` and `week_arg`.
    *   Inside the function, use these arguments to determine `next_month`, `next_week`, `publish_date`, `ephergent_stardate`, and the `target_filename` for the input JSON file. If `month_arg` and `week_arg` are provided, bypass the `get_next_story_id()` call.
    *   **Code Change (app.py):**
        ```python
        # Update function signature:
        def run_generative_workflow(
            reporter_id_arg: Optional[str],
            topic_arg: Optional[str],
            skip_steps: List[str],
            archiver: Archiver,
            month_arg: Optional[int] = None, # NEW PARAMETER
            week_arg: Optional[int] = None   # NEW PARAMETER
            ) -> None:
            # ... existing code ...

            # Replace the "Determine Next Story ID and Calculate Publish Date" block:
            # --- Determine Next Story ID and Calculate Publish Date ---
            if month_arg is not None and week_arg is not None:
                next_month, next_week = month_arg, week_arg
                logger.info(f"Using provided month/week: {next_month:03d}_{next_week:02d}")
            else:
                next_month, next_week = get_next_story_id()
                logger.info(f"Calculated next story ID: {next_month:03d}_{next_week:02d}")

            publish_date = calculate_publish_date(next_month, next_week, SEASON_START_DATE)
            logger.info(f"Calculated publish date: {publish_date.strftime('%Y-%m-%d')}")

            # --- Generate Ephergent Stardate for Metadata ---
            day_of_week = random.randint(1, 7) # Pick a random day within the week
            ephergent_stardate = f"Cycle {next_month:03d}.{next_week:03d}.{day_of_week:03d}"
            logger.info(f"Generated Ephergent Stardate for metadata: {ephergent_stardate}")

            # --- Determine Target Filename ---
            target_filename = f"{next_month:03d}_{next_week:02d}.json"
            target_file_path = INPUT_STORIES_DIR_READY / target_filename

            # ... rest of the function ...

            # Update the call to run_generative_workflow in the __main__ block:
            # Change:
            # run_generative_workflow(args.reporter, args.topic, steps_to_skip_list, main_archiver)
            # To:
            # run_generative_workflow(args.reporter, args.topic, steps_to_skip_list, main_archiver, args.month, args.week)
        ```

3.  **Modify `app.py`'s Denizen workflow (`if args.denizen:` block):**
    *   Use the new `--month` and `--week` arguments to determine the `publish_date` for the Denizen.
    *   Crucially, rename the image files generated by `profile_image_generator` to match the desired `YYYY-MM-DD-slug` format *before* they are used for Pelican export or archiving. This ensures consistent filenames.
    *   **Code Change (app.py):**
        ```python
        # Inside the `if args.denizen:` block, before `denizen_data = generate_denizen_profile(...)`:
        denizen_month = args.month if args.month is not None else datetime.now().month
        denizen_week = args.week if args.week is not None else (datetime.now().day - 1) // 7 + 1
        denizen_publish_date = calculate_publish_date(denizen_month, denizen_week, SEASON_START_DATE)
        logger.info(f"Denizen publish date: {denizen_publish_date.strftime('%Y-%m-%d')}")
        denizen_date_prefix = denizen_publish_date.strftime('%Y-%m-%d')

        # ... existing call to generate_denizen_profile ...
        denizen_data = generate_denizen_profile(denizen_output_dir)
        if not denizen_data:
            raise RuntimeError("Failed to generate Dimensional Denizen profile data.")

        char_name = denizen_data['name']
        char_backstory = denizen_data['backstory']
        char_details = denizen_data['details']

        # NEW: Generate the new filename_base based on the desired date and character name
        new_filename_base = f"{denizen_date_prefix}-{sanitize_filename(char_name)}"
        denizen_metadata['filename_base'] = new_filename_base

        # NEW: Rename the generated image files to match the new filename_base
        original_profile_image_path = denizen_data['profile_image_path']
        original_action_image_path = denizen_data['action_image_path']

        new_profile_image_name = f"{new_filename_base}_profile{original_profile_image_path.suffix}"
        new_action_image_name = f"{new_filename_base}_action{original_action_image_path.suffix}"

        new_profile_image_path = original_profile_image_path.parent / new_profile_image_name
        new_action_image_path = original_action_image_path.parent / new_action_image_name

        if original_profile_image_path.exists():
            original_profile_image_path.rename(new_profile_image_path)
            logger.info(f"Renamed profile image to: {new_profile_image_path.name}")
        else:
            logger.warning(f"Original profile image not found: {original_profile_image_path}")
            new_profile_image_path = None

        if original_action_image_path.exists():
            original_action_image_path.rename(new_action_image_path)
            logger.info(f"Renamed action image to: {new_action_image_path.name}")
        else:
            logger.warning(f"Original action image not found: {original_action_image_path}")
            new_action_image_path = None

        # Update denizen_artifacts with the new paths
        denizen_artifacts["feature_image"] = new_profile_image_path
        denizen_artifacts["article_images"] = new_action_image_path

        # Update image_prompt_details with new filenames (if applicable)
        for prompt_info in denizen_image_prompt_details:
            if prompt_info.get("image_type") == "featured":
                prompt_info["filename"] = new_profile_image_name
            elif prompt_info.get("image_type") == "article":
                prompt_info["filename"] = new_action_image_name

        # Save updated image prompts JSON (using the new_filename_base)
        if denizen_image_prompt_details:
            prompts_json_path = denizen_output_dir / f"{new_filename_base}_image_prompts.json" # Use new filename_base
            try:
                with open(prompts_json_path, 'w', encoding='utf-8') as f: json.dump(denizen_image_prompt_details, f, indent=2)
                denizen_artifacts["image_prompts_file"] = prompts_json_path
            except Exception as e: logger.error(f"Failed to save denizen image prompts JSON: {e}")

        # Ensure subsequent calls use the new_filename_base and denizen_publish_date:
        # Example for format_denizen_pelican_markdown:
        pelican_markdown_content = format_denizen_pelican_markdown(
            char_name=char_name, char_backstory=char_backstory, char_details=char_details,
            feature_image_filename=denizen_artifacts["feature_image"].name if denizen_artifacts.get("feature_image") else None,
            article_image_filename=denizen_artifacts["article_images"].name if denizen_artifacts.get("article_images") else None,
            audio_filename=denizen_artifacts["audio"].name if denizen_artifacts.get("audio") else None,
            youtube_video_url=denizen_youtube_url, author=reporter_obj.name, category=category, tags=tags_list,
            publish_date=denizen_publish_date # Use the calculated publish date
        )
        markdown_temp_path = denizen_output_dir / f"{new_filename_base}.md" # Use new filename_base
        # ... (similar updates for export_to_pelican and archive_artifacts)
        # For export_to_pelican:
        # markdown_filename_base=new_filename_base
        # For archive_artifacts:
        # filename_base=new_filename_base
        ```

### Phase 2: Modify `generate_articles_all_reporters.py` to use the new date arguments.

1.  **Update `generate_articles_all_reporters.py`'s `ArgumentParser`:**
    *   Add `--month`, `--week`, and a `--denizen` flag.
    *   **Code Change (generate_articles_all_reporters.py):**
        ```python
        # In the main block, add to ArgumentParser:
        import argparse
        # ... existing imports ...

        def generate_articles_for_all_reporters(month: Optional[int], week: Optional[int], generate_denizen: bool):
            # ... existing code ...

        if __name__ == "__main__":
            parser = argparse.ArgumentParser(description="Generate articles for all reporters and optionally a Denizen.")
            parser.add_argument(
                "--month",
                type=int,
                default=None,
                help="Specify the month number for all generated articles (e.g., 1 for Cycle 001)."
            )
            parser.add_argument(
                "--week",
                type=int,
                default=None,
                help="Specify the week number for all generated articles (e.g., 1 for Week 01)."
            )
            parser.add_argument(
                "--denizen",
                action="store_true",
                help="Also generate a Dimensional Denizen profile for the specified date."
            )
            args = parser.parse_args()
            generate_articles_for_all_reporters(args.month, args.week, args.denizen)
        ```

2.  **Modify `generate_articles_all_reporters.py`'s `generate_articles_for_all_reporters` function:**
    *   Accept the new `month`, `week`, and `generate_denizen` parameters.
    *   Pass the `month` and `week` arguments to the `app.py --auto-generate` calls.
    *   If `generate_denizen` is true, make an additional call to `app.py --denizen` with the same `month` and `week` arguments.
    *   **Code Change (generate_articles_all_reporters.py):**
        ```python
        # Update function signature:
        def generate_articles_for_all_reporters(month: Optional[int], week: Optional[int], generate_denizen: bool):
            # ... existing code ...

            for reporter in reporters:
                # ... existing code ...

                command = [
                    sys.executable,
                    str(APP_SCRIPT),
                    "--auto-generate",
                    "--reporter", reporter_id,
                    "--skip", skip_steps
                ]
                # NEW: Add month and week arguments if provided
                if month is not None:
                    command.extend(["--month", str(month)])
                if week is not None:
                    command.extend(["--week", str(week)])

                logger.info(f"Running command: {' '.join(command)}")
                # ... existing subprocess.run call ...

            # NEW: Add Denizen generation after all reporters
            if generate_denizen:
                logger.info("\n--- Generating Dimensional Denizen profile ---")
                denizen_command = [
                    sys.executable,
                    str(APP_SCRIPT),
                    "--denizen",
                    "--skip", skip_steps # Apply skip steps to denizen generation too
                ]
                # Add month and week arguments if provided
                if month is not None:
                    denizen_command.extend(["--month", str(month)])
                if week is not None:
                    denizen_command.extend(["--week", str(week)])

                logger.info(f"Running command: {' '.join(denizen_command)}")
                try:
                    result = subprocess.run(denizen_command, capture_output=True, text=True, check=True)
                    logger.info("Successfully generated Dimensional Denizen profile.")
                except subprocess.CalledProcessError as e:
                    logger.error(f"Error generating Denizen profile: Command failed with exit code {e.returncode}")
                    logger.error(f"Subprocess stderr:\n{e.stderr}")
                    logger.error(f"Subprocess stdout:\n{e.stdout}")
                except Exception as e:
                    logger.error(f"An unexpected error occurred while generating Denizen profile: {e}", exc_info=True)

            logger.info("\n--- Finished generating articles for all reporters and Denizen ---")
        ```
